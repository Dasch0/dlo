{% extends "base.html" %}

{% block title %}Match Details - {{ match.time|datetime_format }}{% endblock %}
{% block header %}Match Details - {{ match.time|datetime_format }}{% endblock %}

{% block content %}
<div class="replay-viewer">
    <div id="load-replay-container">
        <button id="load-replay-btn" class="load-button" onclick="loadReplayViewer()">
            Load Replay Viewer
        </button>
    </div>
    <div id="replay-container" style="display: none;">
        <canvas id="renderCanvas" data-report-path="../replays/{{ replay_name }}.bbr"></canvas>
    </div>
</div>

<div class="credit">
    Replays powered by <a href="https://steamcommunity.com/sharedfiles/filedetails/?id=2923199303">Better Battle Report</a>
</div>

<div class="download-section">
    <h3>Downloads</h3>
    <div class="download-links">
        <a href="../BattleReports/{{ replay_name }}.xml" download>Download Skirmish Report (.xml)</a>
        <a href="../replays/{{ replay_name }}.bbr" download>Download Better Battle Report (.bbr)</a>
    </div>
</div>

<div class="match-stats">
    <table class="stats-table">
        <tr>
            <th>Map</th>
            <td>{{ match.map_name }}</td>
        </tr>
        <tr>
            <th>Average DLO</th>
            <td>{{ match.avg_dlo|float_round(2) }}</td>
        </tr>
        <tr>
            <th>Match Quality</th>
            <td>{{ match.match_quality|float_round(2) }}</td>
        </tr>
    </table>
</div>

<div class="teams-container">
    {% for team_id, players in match.teams.items() %}
    <div class="team {{ 'winner' if team_id == match.winning_team else 'loser' }}">
        <h2>{{ 'Winning Team' if team_id == match.winning_team else 'Losing Team' }}</h2>
        {% for player in players %}
        <div class="player-card">
            <h3>
                <a href="../player/{{ player.player_id }}.html">
                    {{ player.steam_name }} ({{ player.faction }})
                </a>
            </h3>
            {% if player.fleet is defined %}
            <div class="fleet-info">
                <a href="../fleets/{{ player.fleet.fleet_image }}">
                    <img src="../fleets/{{ player.fleet.fleet_image }}" 
                         class="fleet-preview" 
                         alt="{{ player.steam_name }}'s Fleet">
                </a>
                <a href="../fleets/{{ player.fleet.fleet_file }}" download 
                   class="download-link">
                    Download Fleet File
                </a>
            </div>
            {% else %}
            <div class="fleet-missing">
                Fleet Composition: REDACTED
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endfor %}
</div>

<a href="../replays/{{ replay_name }}.bbr" download>Download Better Battle Report (.bbr)</a>

<script>
function loadReplayViewer() {
    const container = document.getElementById('replay-container');
    const button = document.getElementById('load-replay-btn');
    const loadContainer = document.getElementById('load-replay-container');
    
    // Show replay viewer
    container.style.display = 'block';
    
    // Hide load button and note
    loadContainer.style.display = 'none';
    
    // Dynamically inject BBR script and canvas setup
    const script = document.createElement('script');
    script.type = 'module';
    script.src = '../bbr/index.8af4629a.js';
    
    const canvas = document.getElementById('renderCanvas');
    const reportPath = canvas.getAttribute('data-report-path');
    
    // Insert script after canvas element
    canvas.parentNode.insertBefore(script, canvas.nextSibling);
    
    // Scroll to replay viewer
    container.scrollIntoView({ behavior: 'smooth' });
    
    // Update button state
    button.textContent = 'Viewer Loaded';
    button.disabled = true;
}
</script>
{% endblock %}
